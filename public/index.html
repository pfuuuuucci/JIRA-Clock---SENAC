<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Reconhecimento de Voz - JIRA Helper</title>
    <!-- Verifica√ß√£o de Autentica√ß√£o IMEDIATA - ANTES de qualquer renderiza√ß√£o -->
    <script>
        (function() {
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) {
                // Usu√°rio n√£o autenticado - redirecionar IMEDIATAMENTE
                window.location.replace('/login.html');
                return; // Para a execu√ß√£o
            }
        })();
    </script>
    <!-- Mudei aqui, criando um novo estilo de container -->
<style>
        .index-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .config-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .config-section h3 {
            color: #1f2937;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #3b82f6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .project-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-info {
            flex: 1;
        }

        .project-info div {
            margin-bottom: 5px;
        }

        .project-info strong {
            color: #1f2937;
        }

        .project-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px;
            font-size: 1.1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background: transparent;
            color: #6b7280;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            color: #dc2626;
            background: transparent;
            transform: translateY(-1px);
        }

        .new-project-form {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .new-project-form h4 {
            color: #1e40af;
            margin: 0 0 15px 0;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background: #f0fdf4;
            color: #059669;
            border: 1px solid #bbf7d0;
        }

        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        /* Garantir que bot√µes ocupem toda a largura como na p√°gina principal */
        .btn {
            width: 100% !important;
            box-sizing: border-box;
        }


    </style>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JIRA Voice">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="format-detection" content="telephone=no">

    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="/original-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/original-icon.png">
    <link rel="manifest" href="/manifest.json">

    <link rel="stylesheet" href="/styles.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
    <div class="index-container">
        <header>
            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: left;">
                    <h1>Assistente de Voz</h1>
                    <p id="headerSubtitle">Apontamentos JIRA - </p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                    <button onclick="logout()" class="header-icon-btn" title="Sair">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
                            <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                        </svg>
                    </button>
                    
                    <a href="/consulta.html" class="header-icon-btn" title="Consultar Apontamentos">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71z"/>
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0"/>
                        </svg>
                    </a>
                </div>
            </div>
        </header>

        <main>
            <!-- Campo de sele√ß√£o de data -->
            <div class="form-group">
                <input type="date" class="form-control" id="worklogDate" required>
            </div>

            <div class="voice-controls">
                <button id="startBtn" class="btn btn-primary" title="Iniciar Grava√ß√£o">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5"/>
                        <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3"/>
                    </svg>
                </button>
                <button id="stopBtn" class="btn btn-secondary" disabled title="Parar Grava√ß√£o">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5"/>
                    </svg>
                </button>
                <button id="clearBtn" class="btn btn-danger" title="Limpar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                    </svg>
                </button>
            </div>

            <div class="status" id="status">
                Pronto para ouvir...
            </div>

            <div class="transcript-container">
                <h3>Transcri√ß√£o:</h3>
                <div id="transcript" class="transcript-box">
                    <p class="placeholder">A transcri√ß√£o aparecer√° aqui...</p>
                </div>
            </div>

            <div class="jira-result-container">
                <div id="jiraResult" class="jira-result" style="display: none;"></div>
            </div>

            <div class="action-buttons">
                <button id="analyzeBtn" class="btn btn-success">
                    <span class="btn-icon"></span>
                    Analisar
                </button>
                <button id="newAppointmentBtn" class="btn btn-secondary">
                    <span class="btn-icon"></span>
                    Novo Registro
                </button>
            </div>

            <div class="favorites-filter">
                <label class="checkbox-container">
                    <input type="checkbox" id="favoritesOnly" checked>
                    <span class="checkmark">‚≠ê</span>
                    Buscar apenas nos Favoritos
                </label>
            </div></div>
        </main>

        <footer>
            <p>Powered by GRUPO 02 - SENAC</p>
        </footer>
    </div>

    <script>
        // Inicializa√ß√£o do app (usu√°rio j√° foi verificado no head)
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = sessionStorage.getItem('currentUser');
            
            try {
                const userData = JSON.parse(currentUser);
                console.log('‚úÖ Usu√°rio autenticado:', userData.username);

                // Atualizar o subt√≠tulo com o nome do usu√°rio
                const headerSubtitle = document.getElementById('headerSubtitle');
                if (headerSubtitle) {
                    headerSubtitle.textContent = `Apontamentos JIRA - ${userData.username}`;
                }

                // Definir data padr√£o no campo de data (mesma l√≥gica do consulta.html)
                setDefaultWorklogDate();

            } catch (error) {
                console.error('Erro ao verificar usu√°rio:', error);
                window.location.href = '/login.html';
            }
        });

        function setDefaultWorklogDate() {
            // Verificar hora atual
            const now = new Date();
            const currentHour = now.getHours();
            
            // Se for 21:00 ou mais, usar o dia anterior como padr√£o
            if (currentHour >= 21) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const defaultDate = yesterday.toISOString().split('T')[0];
                document.getElementById('worklogDate').value = defaultDate;
                console.log(`üïò Ap√≥s 21:00 (${currentHour}h) - usando data anterior: ${defaultDate}`);
            } else {
                // Antes das 21:00, usar hoje normalmente
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('worklogDate').value = today;
                console.log(`üïê Antes das 21:00 (${currentHour}h) - usando data atual: ${today}`);
            }
        }

        function logout() {
            // NOVO: Limpar token di√°rio ao fazer logout
            try {
                const currentUser = sessionStorage.getItem('currentUser');
                if (currentUser) {
                    const userData = JSON.parse(currentUser);
                    const username = userData.username;
                    
                    // Gerar mesmo device fingerprint para limpeza
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillText('Device fingerprint', 2, 2);
                    
                    const deviceFingerprint = btoa(
                        navigator.userAgent + 
                        screen.width + 
                        screen.height + 
                        navigator.platform + 
                        (navigator.hardwareConcurrency || 'unknown') +
                        canvas.toDataURL() +
                        navigator.language +
                        new Date().getTimezoneOffset()
                    ).substring(0, 32);
                    
                    // Remover token di√°rio deste dispositivo
                    const tokenKey = `jira_daily_token_${username}_${deviceFingerprint}`;
                    if (localStorage.getItem(tokenKey)) {
                        localStorage.removeItem(tokenKey);
                        console.log('üóëÔ∏è Token di√°rio removido no logout');
                    }
                }
            } catch (error) {
                console.error('Erro ao limpar token di√°rio:', error);
            }
            
            sessionStorage.removeItem('currentUser');
            window.location.href = '/login.html';
        }
    </script>
    <script src="/app.js"></script>
</body>
</html>